<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>심폐소생술 시각화(모바일+카운터+연동제어+리셋)</title>
<style>
  :root{
    --bpm-ms: 545ms; /* 110회/분 */
  }
  *{box-sizing:border-box}
  body {
    margin:0;
    background:#f5f7fb;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    color:#111;
  }
  header{
    text-align:center;
    padding:clamp(8px, 3vh, 24px);
    font-weight:700;
    font-size:clamp(18px, 2.6vh, 28px);
  }
  .wrap{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    justify-items:center;
    gap:clamp(8px, 3vw, 24px);
    padding:clamp(8px, 3vw, 20px);
  }
  .center{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
  }
  .counter{
    font-weight:800;
    line-height:1;
    letter-spacing:1px;
    text-align:center;
    font-size: clamp(28px, 6vh, 64px);
    margin-bottom: clamp(6px, 1.2vh, 12px);
    padding: 2px 10px;
    border-radius: 12px;
    background: rgba(255,255,255,.7);
    box-shadow: 0 2px 10px rgba(0,0,0,.06);
  }
  .img{
    max-width: 36vw;
    width: clamp(120px, 36vw, 240px);
    height:auto;
  }
  .bar{
    width: clamp(56px, 18vw, 110px);
    height: clamp(200px, 46vh, 520px);
    background: #1a73e8;
    border-radius: 24px;
    animation: compress var(--bpm-ms) infinite ease-in-out;
    animation-play-state: paused; /* 기본 멈춤 */
    transform-origin: bottom center;
    box-shadow: 0 6px 18px rgba(0,0,0,.12) inset, 0 6px 16px rgba(0,0,0,.08);
  }
  .bar.running{ animation-play-state: running; } /* 시작 시 재생 */
  .bar.reset{ transform: scaleY(1) !important; background:#1a73e8 !important; } /* 리셋 모양 */
  @keyframes compress {
    0%,100% { transform: scaleY(1); background: #1a73e8; } /* 이완 (파랑) */
    50% { transform: scaleY(0.2); background: #ea4335; }   /* 압박 (빨강, 바닥까지) */
  }
  footer{
    text-align:center;
    padding:clamp(8px, 2.8vh, 22px);
    font-size:clamp(13px, 2vh, 18px);
  }
  .controls{
    display:flex; gap:10px; justify-content:center; margin:8px 0 2px;
  }
  button{
    padding:10px 14px;
    border:none; border-radius:12px;
    font-size:16px; font-weight:600;
    background:#111; color:#fff;
  }
  button.secondary{ background:#444; }
  @media (max-width: 420px){
    .wrap{ grid-template-columns: 1fr; }
    .img{ display:none; }
  }
</style>
</head>
<body>
  <header>심폐소생술 압박/이완 훈련</header>

  <div class="controls">
    <button id="startBtn">시작</button>
    <button id="fsBtn" class="secondary">전체화면</button>
    <button id="resetBtn" class="secondary">카운터/막대 리셋</button>
  </div>

  <div class="wrap">
    <img class="img" src="press.png.png" alt="압박 이미지">
    <div class="center">
      <div id="counter" class="counter">0</div>
      <div class="bar reset" id="bar"></div>
    </div>
    <img class="img" src="release.png.png" alt="이완 이미지">
  </div>

  <footer>속도: 분당 100~120회 속도, 깊이: 5cm</footer>

<script>
  // 오디오: 사용자 제스처 후에만 재생 가능(모바일 정책)
  let audioCtx = null;
  let timer = null;
  const period = 545; // ms (110 bpm)
  let count = 0;
  const startBtn = document.getElementById('startBtn');
  const fsBtn = document.getElementById('fsBtn');
  const resetBtn = document.getElementById('resetBtn');
  const counterEl = document.getElementById('counter');
  const barEl = document.getElementById('bar');

  function clickSound(){
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "square";
    osc.frequency.value = 1200;      // 메트로놈 느낌 "땅"
    gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.8, audioCtx.currentTime + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.10);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.12);
  }

  function tick(){
    clickSound();
    // 카운터 증가 (1~30 반복)
    count = (count % 30) + 1;
    counterEl.textContent = count;
  }

  function start(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(timer) return;
    // 리셋 상태 제거, 애니메이션 재시작을 위해 강제 리플로우
    barEl.classList.remove('reset');
    barEl.style.animation = 'none';
    void barEl.offsetWidth; // reflow
    barEl.style.animation = '';
    // 애니메이션 시작
    barEl.classList.add('running');
    // 카운터/소리 시작
    tick(); // 첫 박자 즉시
    timer = setInterval(tick, period);
    startBtn.textContent = "정지";
  }
  function stop(){
    if(timer){ clearInterval(timer); timer = null; }
    // 애니메이션 정지
    barEl.classList.remove('running');
    startBtn.textContent = "시작";
  }
  function resetAll(){
    // 카운터 초기화
    count = 0;
    counterEl.textContent = count;
    // 정지
    stop();
    // 막대 원위치/파랑으로
    barEl.classList.add('reset');
    // 애니메이션 프레임을 완전 초기화
    barEl.style.animation = 'none';
    void barEl.offsetWidth; // reflow
    barEl.style.animation = 'compress var(--bpm-ms) infinite ease-in-out';
  }

  startBtn.addEventListener('click', ()=> (timer? stop() : start()));
  fsBtn.addEventListener('click', ()=> {
    const el = document.documentElement;
    if (document.fullscreenElement) {
      document.exitFullscreen();
    } else {
      if (el.requestFullscreen) el.requestFullscreen();
    }
  });
  resetBtn.addEventListener('click', resetAll);
</script>
</body>
</html>
